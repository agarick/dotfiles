#! /usr/bin/env tclsh

source $::env(HOME)/bin/lib.tcl

need 0temper pkill swaylock swaymsg

set arg [lindex $::argv 0]

proc kill {} {
  catch {exec pkill dbus-daemon}
  catch {exec pkill dbus-launch}
  #catch {exec pkill pulseaudio}
}

proc save {} {
  global LOGW LOGX

  foreach f "$LOGW $LOGX" {
    if {[file exists $f]} {
      file rename -force -- $f $f.old
    }
  }
}

proc sync {} {
  exec 0temper
}

switch -- $arg {

  k - o - lock {
    if {{w} eq $SESS} { exec swaylock -f -c 000000; }
  }

  e - l - q - x - logout {
    save
    kill
    if {{w} eq $SESS} { exec swaymsg exit; }
    if {{x} eq $SESS} { exec pkill cwm; }
  }

  z - sleep {
    sync
    exec sudo zzz
  }

  b - r - reboot {
    save
    sync
    kill
    exec sudo reboot
  }

  h - s - shutdown {
    save
    sync
    kill
    exec sudo halt
  }
}

